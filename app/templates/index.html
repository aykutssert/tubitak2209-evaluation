<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8" />
    <title>2209-A Project Evaluation</title>
    <style>
        body {
            background-color: #1c1c1c;
            color: #f0f0f0;
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 90%;
            margin: auto;
        }

        h1,
        h2 {
            color: #ffffff;
        }

        form {
            background-color: #2c2c2c;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        input[type="file"],
        textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            background-color: #3a3a3a;
            color: #f0f0f0;
            border: none;
            border-radius: 5px;
        }

        .button2 {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #45a049;
        }

        .error {
            color: #ff6666;
            font-weight: bold;
        }

        #loadingMessage {
            font-weight: bold;
        }

        .report-section {
            background-color: #2c2c2c;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 5px solid #4CAF50;
            border-radius: 8px;
        }

        .report-section:not(:first-child) {
            page-break-before: always;
        }

        #reportContainer {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .report-section h3 {
            color: #aaffaa;
            margin-top: 0;
        }

        .report-question {
            margin: 10px 0 5px 0;
            font-weight: bold;
            color: #ffffff;
        }

        .report-answer {
            background-color: #3a3a3a;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-line;
            color: #dddddd;
            margin-bottom: 10px;
        }

        .section-score {
            font-style: italic;
            color: #bbbbbb;
            margin-top: 10px;
        }

        .total-score-box {
            background-color: #2c2c2c;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            color: #aaffaa;
        }

        .model-select {
            background-color: white;
            color: black;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            margin: 10px 0;
            width: 100%;
        }
    </style>
</head>

<body>
    <h1>üìÑ 2209-A Project Evaluation</h1>

    <form id="uploadForm">
        <input type="file" id="fileInput" accept=".docx" required />

        <!-- Mod Se√ßimi -->
        <select id="modeSelect" name="mode" class="model-select">
            <option value="evaluate">üìä Evaluation the project</option>
            <option value="rag">üí¨ Ask questions about the project</option>
        </select>

        <!-- Soru Alanƒ± -->
        <textarea id="questionInput" rows="4" placeholder="Belgeye dayalƒ± bir soru yazƒ±n..."
            style="display: none;"></textarea>

        <!-- Engine Se√ßimi -->
        <select id="engineSelect" name="engine" class="model-select">
            <option value="api">üåê API Model</option>
            <option value="local">üîß Local Model</option>
        </select>

        <!-- Model Se√ßimi -->
        <select id="modelSelect" name="model" class="model-select">
            <option value="gpt-4o-mini-2024-07-18">gpt-4o-mini</option>
            <option value="gpt-4.1-nano-2025-04-14">gpt-4.1-nano</option>
            <option value="gpt-4.1-mini-2025-04-14">gpt-4.1-mini</option>
        </select>

        <button type="submit" class="button2" id="uploadBtn">Upload</button>

        <p class="error" id="errorMessage" style="display: none;"></p>
        <p id="loadingMessage" style="display: none;">‚è≥ Loading...</p>
    </form>

    <h2 id="resultTitle" style="display: none;">üìù Result:</h2>
    <div id="totalScoreBox" class="total-score-box" style="display: none;"></div>
    <button class="button2" id="downloadPdfBtn" style="display:none; margin-bottom: 20px;">üì• Download as PDF</button>
    <div id="reportContainer" style="display: none;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        const modelOptions = {
            local: [
                { value: "gemma3:4b", label: "gemma3:4b" },
                { value: "gemma3:12b", label: "gemma3:12b" }
            ],
            api: [
                { value: "gpt-4o-mini-2024-07-18", label: "gpt-4o-mini" },
                { value: "gpt-4.1-nano-2025-04-14", label: "gpt-4.1-nano" },
                { value: "gpt-4.1-mini-2025-04-14", label: "gpt-4.1-mini" }
            ]
        };

        document.getElementById("engineSelect").addEventListener("change", function () {
            const selectedEngine = this.value;
            const modelSelect = document.getElementById("modelSelect");

            modelSelect.innerHTML = "";
            modelOptions[selectedEngine].forEach(option => {
                const opt = document.createElement("option");
                opt.value = option.value;
                opt.textContent = option.label;
                modelSelect.appendChild(opt);
            });
        });

        document.getElementById("modeSelect").addEventListener("change", function () {
            const questionInput = document.getElementById("questionInput");
            questionInput.style.display = this.value === "rag" ? "block" : "none";
        });

        document.getElementById("uploadForm").addEventListener("submit", function (e) {
            e.preventDefault();

            const uploadBtn = document.getElementById("uploadBtn");
            uploadBtn.disabled = true;
            uploadBtn.textContent = "‚è≥ Loading...";

            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];
            const mode = document.getElementById("modeSelect").value;
            const question = document.getElementById("questionInput").value.trim();

            if (!file || !file.name.endsWith(".docx")) {
                showError("Sadece .docx dosyalarƒ± y√ºklenebilir.");
                return;
            }

            if (mode === "rag" && question === "") {
                showError("Soru alanƒ± bo≈ü bƒ±rakƒ±lamaz.");
                return;
            }

            const formData = new FormData();
            formData.append("file", file);
            formData.append("mode", mode);
            formData.append("question", question);
            formData.append("engine", document.getElementById("engineSelect").value);
            formData.append("model", document.getElementById("modelSelect").value);

            document.getElementById("errorMessage").style.display = "none";
            // document.getElementById("loadingMessage").style.display = "block";
            document.getElementById("reportContainer").style.display = "none";
            document.getElementById("totalScoreBox").style.display = "none";
            document.getElementById("downloadPdfBtn").style.display = "none";

            const route = mode === "rag" ? "/ask" : "/upload";
            fetch(route, {
                method: "POST",
                body: formData,
            })
                .then(res => res.json())
                .then(data => {
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = "Upload";
                    // document.getElementById("loadingMessage").style.display = "none";

                    if (data.error) {
                        showError(data.error);
                        return;
                    }

                    if (mode === "rag") {
                        document.getElementById("resultTitle").style.display = "block";
                        document.getElementById("reportContainer").style.display = "grid";
                        document.getElementById("reportContainer").innerHTML = "";

                        const sectionDiv = document.createElement("div");
                        sectionDiv.className = "report-section";

                        const title = document.createElement("h3");
                        title.textContent = "Soru-Cevap Sonucu";
                        sectionDiv.appendChild(title);

                        const qEl = document.createElement("div");
                        qEl.className = "report-question";
                        qEl.textContent = question;
                        sectionDiv.appendChild(qEl);

                        const aEl = document.createElement("div");
                        aEl.className = "report-answer";
                        aEl.textContent = data.answer;
                        sectionDiv.appendChild(aEl);

                        document.getElementById("reportContainer").appendChild(sectionDiv);
                        return;
                    }


                    document.getElementById("resultTitle").style.display = "block";
                    document.getElementById("reportContainer").style.display = "grid";
                    document.getElementById("reportContainer").innerHTML = "";
                    document.getElementById("downloadPdfBtn").style.display = "inline-block";

                    const answers = data.answers || {};
                    const scores = data.section_scores || {};

                    let totalScore = 0;
                    let totalMaxScore = 0;

                    for (const section in answers) {
                        const sectionDiv = document.createElement("div");
                        sectionDiv.className = "report-section";
                        const questionSet = answers[section];
                        const questionCount = Object.keys(questionSet).length;
                        const maxScore = questionCount * 5;
                        const sectionScore = scores[section] || 0;

                        totalScore += sectionScore;
                        totalMaxScore += maxScore;

                        const title = document.createElement("h3");
                        title.textContent = `${section} (${maxScore} Puan)`;
                        sectionDiv.appendChild(title);

                        for (const question in questionSet) {
                            const qEl = document.createElement("div");
                            qEl.className = "report-question";
                            qEl.textContent = question;
                            sectionDiv.appendChild(qEl);

                            const aEl = document.createElement("div");
                            aEl.className = "report-answer";
                            aEl.textContent = questionSet[question];
                            sectionDiv.appendChild(aEl);
                        }

                        const scoreEl = document.createElement("div");
                        scoreEl.className = "section-score";
                        scoreEl.textContent = `Puan: ${sectionScore}`;
                        sectionDiv.appendChild(scoreEl);

                        document.getElementById("reportContainer").appendChild(sectionDiv);
                    }

                    const totalScoreBox = document.getElementById("totalScoreBox");
                    totalScoreBox.textContent = `Total Points: ${totalScore} / ${totalMaxScore}`;
                    totalScoreBox.style.display = "block";
                })
                .catch(err => {
                    showError("‚ö†Ô∏è Sunucu hatasƒ±: " + err.message);
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = "Upload";
                    document.getElementById("loadingMessage").style.display = "none";
                });
        });

        function showError(message) {
            const errorEl = document.getElementById("errorMessage");
            errorEl.textContent = message;
            errorEl.style.display = "block";
            document.getElementById("uploadBtn").disabled = false;
            document.getElementById("uploadBtn").textContent = "G√∂nder";
        }
    </script>
</body>

</html>